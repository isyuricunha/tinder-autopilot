(function(){"use strict";function Te(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var N={exports:{}},ve=N.exports,te;function Ie(){return te||(te=1,(function(e,a){(function(t,i){i(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:ve,function(t){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)t.exports=globalThis.browser;else{const i="The message port closed before a response was received.",o=r=>{const d={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(d).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class w extends WeakMap{constructor(c,u=void 0){super(u),this.createItem=c}get(c){return this.has(c)||this.set(c,this.createItem(c)),super.get(c)}}const E=l=>l&&typeof l=="object"&&typeof l.then=="function",F=(l,c)=>(...u)=>{r.runtime.lastError?l.reject(new Error(r.runtime.lastError.message)):c.singleCallbackArg||u.length<=1&&c.singleCallbackArg!==!1?l.resolve(u[0]):l.resolve(u)},v=l=>l==1?"argument":"arguments",Be=(l,c)=>function(m,...b){if(b.length<c.minArgs)throw new Error(`Expected at least ${c.minArgs} ${v(c.minArgs)} for ${l}(), got ${b.length}`);if(b.length>c.maxArgs)throw new Error(`Expected at most ${c.maxArgs} ${v(c.maxArgs)} for ${l}(), got ${b.length}`);return new Promise((S,k)=>{if(c.fallbackToNoCallback)try{m[l](...b,F({resolve:S,reject:k},c))}catch(g){console.warn(`${l} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,g),m[l](...b),c.fallbackToNoCallback=!1,c.noCallback=!0,S()}else c.noCallback?(m[l](...b),S()):m[l](...b,F({resolve:S,reject:k},c))})},xe=(l,c,u)=>new Proxy(c,{apply(m,b,S){return u.call(b,l,...S)}});let L=Function.call.bind(Object.prototype.hasOwnProperty);const z=(l,c={},u={})=>{let m=Object.create(null),b={has(k,g){return g in l||g in m},get(k,g,y){if(g in m)return m[g];if(!(g in l))return;let h=l[g];if(typeof h=="function")if(typeof c[g]=="function")h=xe(l,l[g],c[g]);else if(L(u,g)){let R=Be(g,u[g]);h=xe(l,l[g],R)}else h=h.bind(l);else if(typeof h=="object"&&h!==null&&(L(c,g)||L(u,g)))h=z(h,c[g],u[g]);else if(L(u,"*"))h=z(h,c[g],u["*"]);else return Object.defineProperty(m,g,{configurable:!0,enumerable:!0,get(){return l[g]},set(R){l[g]=R}}),h;return m[g]=h,h},set(k,g,y,h){return g in m?m[g]=y:l[g]=y,!0},defineProperty(k,g,y){return Reflect.defineProperty(m,g,y)},deleteProperty(k,g){return Reflect.deleteProperty(m,g)}},S=Object.create(l);return new Proxy(S,b)},Y=l=>({addListener(c,u,...m){c.addListener(l.get(u),...m)},hasListener(c,u){return c.hasListener(l.get(u))},removeListener(c,u){c.removeListener(l.get(u))}}),Ue=new w(l=>typeof l!="function"?l:function(u){const m=z(u,{},{getContent:{minArgs:0,maxArgs:0}});l(m)}),ke=new w(l=>typeof l!="function"?l:function(u,m,b){let S=!1,k,g=new Promise(O=>{k=function(I){S=!0,O(I)}}),y;try{y=l(u,m,k)}catch(O){y=Promise.reject(O)}const h=y!==!0&&E(y);if(y!==!0&&!h&&!S)return!1;const R=O=>{O.then(I=>{b(I)},I=>{let ee;I&&(I instanceof Error||typeof I.message=="string")?ee=I.message:ee="An unexpected error occurred",b({__mozWebExtensionPolyfillReject__:!0,message:ee})}).catch(I=>{console.error("Failed to send onMessage rejected reply",I)})};return R(h?y:g),!0}),$e=({reject:l,resolve:c},u)=>{r.runtime.lastError?r.runtime.lastError.message===i?c():l(new Error(r.runtime.lastError.message)):u&&u.__mozWebExtensionPolyfillReject__?l(new Error(u.message)):c(u)},ye=(l,c,u,...m)=>{if(m.length<c.minArgs)throw new Error(`Expected at least ${c.minArgs} ${v(c.minArgs)} for ${l}(), got ${m.length}`);if(m.length>c.maxArgs)throw new Error(`Expected at most ${c.maxArgs} ${v(c.maxArgs)} for ${l}(), got ${m.length}`);return new Promise((b,S)=>{const k=$e.bind(null,{resolve:b,reject:S});m.push(k),u.sendMessage(...m)})},Le={devtools:{network:{onRequestFinished:Y(Ue)}},runtime:{onMessage:Y(ke),onMessageExternal:Y(ke),sendMessage:ye.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:ye.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},q={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return d.privacy={network:{"*":q},services:{"*":q},websites:{"*":q}},z(r,Le,d)};t.exports=o(chrome)}})})(N)),N.exports}var Ee=Ie();const n=Te(Ee),j="https://app.auto-swiper.ch/api/v3",se=j+"/login",ae=j+"/sessions/start",ie=j+"/sessions/end",ne=j+"/scheduled-sessions/next",oe=j+"/heartbeat";let re=!1;async function H(){const e=await n.storage.local.get({withDebuggerOutput:null});e.withDebuggerOutput!==null&&(re=e.withDebuggerOutput)}H();async function s(...e){re&&console.log(...e)}async function le(){const e=await n.storage.local.get({withImageBlocking:null});return e.withImageBlocking!==null?e.withImageBlocking:null}const W=async(e,a,t)=>{if(e.loginEmail.length<4||e.loginPassword.length<4)return;const i={method:"GET",url:se,params:{uuid:e.uuid},auth:{username:e.loginEmail.toLowerCase(),password:e.loginPassword},headers:{Accept:"application/json","Content-Type":"application/json"}};try{let r=(await a.request(i)).data;e.loginToken=r.data.token,await n.storage.local.set({loginToken:r.data.token})}catch(o){s(o),t.warning(n.i18n.getMessage("ERROR_LOGIN_REQUEST"))}},ce=async(e,a,t)=>{if(!e.loginToken||e.loginToken.length<20)throw new Error("No valid authentication token");const i=new URL(ne);i.searchParams.append("uuid",e.uuid);const o={method:"GET",headers:{Authorization:"Bearer "+e.loginToken,"Content-Type":"application/json"}};try{const r=await fetch(i.toString(),o);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const d=await r.json();return s("Next scheduled session:",d),d}catch(r){throw s("Error getting next scheduled session:",r),r}},Me=async(e,a,t,i)=>{if(!a.loginToken||a.loginToken.length<20)if(t)await W(a,t,i);else throw new Error("No valid authentication token");const o={method:"POST",headers:{Authorization:"Bearer "+a.loginToken,"Content-Type":"application/json"},body:JSON.stringify({uuid:a.uuid,site:e.site,scheduled_session_id:e.scheduled_session_id||null})};try{const r=await fetch(ae,o);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const d=await r.json();return s("Session started:",d),i&&i.success("Session started successfully"),d}catch(r){throw s("Error starting session:",r),i&&i.error("Failed to start session: "+r.message),r}},de=async(e,a,t,i,o)=>{if(!t.loginToken||t.loginToken.length<20)throw new Error("No valid authentication token");const r={method:"PUT",headers:{Authorization:"Bearer "+t.loginToken,"Content-Type":"application/json"},body:JSON.stringify({uuid:t.uuid,session_id:e,swipes_left:0,swipes_right:0,swipes_total:0,status:"failed",failure_reason:a.reason||"Session execution failed",error_details:{error_message:a.message||"Unknown error",error_stack:a.stack,timestamp:a.timestamp||new Date().toISOString(),session_type:a.session_type||"regular"},ended_at:new Date().toISOString()})};try{const d=await fetch(ie,r);if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const w=await d.json();return s("Session failed and reported:",w),w}catch(d){throw s("Error reporting session failure:",d),d}},ge=async(e,a,t,i)=>{if(!a.loginToken||a.loginToken.length<20)if(t)await W(a,t,i);else throw new Error("No valid authentication token");const o={method:"POST",headers:{Authorization:"Bearer "+a.loginToken,"Content-Type":"application/json"},body:JSON.stringify({uuid:a.uuid,...e})};try{const r=await fetch(oe,o);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const d=await r.json();return s("Heartbeat sent:",d),d}catch(r){throw s("Error sending heartbeat:",r),r}},Pe=Object.freeze(Object.defineProperty({__proto__:null,endSessionUrl:ie,failSession:de,getAuthToken:W,getNextScheduledSession:ce,getNextScheduledSessionUrl:ne,getWithImageBlocking:le,heartbeatUrl:oe,loadWithDebuggerOutput:H,log:s,loginUrl:se,sendHeartbeat:ge,startSession:Me,startSessionUrl:ae},Symbol.toStringTag,{value:"Module"}));function De(e){n.notifications.create({type:"basic",iconUrl:"icons/icon_128.png",title:"Auto Swiper",message:e})}const Ce=async(e,a)=>Math.random()*(a-e)+e,G=async()=>{const e=await n.storage.local.get({longitude:null,latitude:null});await n.scripting.unregisterContentScripts({ids:["protected","unprotected"]}).catch(()=>{}),e.longitude!==null&&await n.scripting.registerContentScripts([{id:"unprotected",matches:["*://*/*"],allFrames:!0,matchOriginAsFallback:!0,runAt:"document_start",js:["unprotected.js"],world:"MAIN"},{id:"protected",matches:["*://*/*"],allFrames:!0,matchOriginAsFallback:!0,runAt:"document_start",js:["protected.js"],world:"ISOLATED"}])},Re=async()=>{(await n.tabs.query({url:["*://tinder.com/*","*://*.tinder.com/*","*://bumble.com/app/*","*://*.bumble.com/app/*","*://lovoo.com/*","*://*.lovoo.com/*","*://okcupid.com/*","*://*.okcupid.com/*","*://badoo.com/*","*://*.badoo.com/*","*://pof.com/*","*://*.pof.com/*","*://zoosk.com/*","*://*.zoosk.com/*","*://match.com/d/*","*://*.match.com/d/*"]})).forEach(function(a){n.tabs.reload(a.id)})};chrome.runtime.onStartup.addListener(G),chrome.runtime.onInstalled.addListener(G);let D=!1,f=null,V=!1,A=null,B=null;const T=new Set,je=async(e,a,t)=>{try{await n.tabs.get(e)}catch{s(`Tab ${e} does not exist. Skipping sendDebuggerMousePressedCommand.`);return}const i=()=>{T.add(e),chrome.debugger.sendCommand({tabId:e},"Input.dispatchMouseEvent",{type:"mousePressed",x:a,y:t,button:"left",clickCount:1},()=>{chrome.debugger.sendCommand({tabId:e},"Input.dispatchMouseEvent",{type:"mouseReleased",x:a,y:t,button:"left",clickCount:1},()=>{})})};T.has(e)?i():chrome.debugger.attach({tabId:e},"1.2",i)},_e=async(e,a)=>{try{await n.tabs.get(e)}catch{s(`Tab ${e} does not exist. Skipping sendDebuggerKeyEventCommand.`);return}const t={type:"keyDown",key:"ArrowDown",code:"ArrowDown"};t.key=a.key.toString(),t.code=a.code.toString();const i=()=>{T.add(e),chrome.debugger.sendCommand({tabId:e},"Input.dispatchKeyEvent",t,function(o){t.type="keyUp",chrome.debugger.sendCommand({tabId:e},"Input.dispatchKeyEvent",t,()=>{})})};T.has(e)?i():chrome.debugger.attach({tabId:e},"1.2",i)};let P=!1,p=null,x=1;const ue=async()=>{try{if(!p||!p.minMaxSwipeTime||!Array.isArray(p.minMaxSwipeTime)){s("Error: Invalid options or minMaxSwipeTime in loop");return}(typeof x!="number"||isNaN(x))&&(s("Error: Invalid siteSwipeSpeedModifier in loop:",x),x=1);const e=await Ce(p.minMaxSwipeTime[0]*x*1e3,p.minMaxSwipeTime[1]*x*1e3);if(s("Loop timeout calculated:",e,"ms"),isNaN(e)||e<=0){s("Error: Invalid timeout calculated:",e);return}const a=Date.now()+e;setTimeout(function(){if(P){s("Loop stopped, not continuing");return}s("sent: auto-swiper-message-contentjs-check-loop"),n.tabs.get(p.tabId).then(()=>{n.tabs.sendMessage(p.tabId,{action:"auto-swiper-message-contentjs-check-loop"})}).catch(()=>{s(`Tab ${p.tabId} does not exist. Skipping sendMessage in loop.`)}),n.alarms.create("auto-swiper-alarm-loop",{when:a})},e)}catch(e){s("Error in loop function:",e)}},Fe=async()=>{let e=await le();console.log("withImageBlocking: "+e),e?chrome.declarativeNetRequest.updateSessionRules({addRules:[{id:1,priority:1,action:{type:"block"},condition:{urlFilter:"*://images-ssl.gotinder.com",resourceTypes:["image"]}},{id:2,priority:2,action:{type:"block"},condition:{urlFilter:"*://*.bumbcdn.com",resourceTypes:["image"]}},{id:3,priority:3,action:{type:"block"},condition:{urlFilter:"*://img.lovoo.com",resourceTypes:["image"]}},{id:4,priority:4,action:{type:"block"},condition:{urlFilter:"*://cdn.okccdn.com",resourceTypes:["image"]}},{id:5,priority:5,action:{type:"block"},condition:{urlFilter:"*://*.badoocdn.com",resourceTypes:["image"]}},{id:6,priority:6,action:{type:"block"},condition:{urlFilter:"*://pics.pof.com",resourceTypes:["image"]}},{id:7,priority:7,action:{type:"block"},condition:{urlFilter:"*://*.zoosk.com",resourceTypes:["image"]}},{id:8,priority:8,action:{type:"block"},condition:{urlFilter:"*://*.akamaihd.net/photo/",resourceTypes:["image"]}}]}):chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[1,2,3,4,5,6,7]})};n.runtime.onMessage.addListener(async function(e,a,t){if(e.action==="startAuthenticatedServices"){s("Received request to start authenticated services"),await X();return}if(e.action==="stopAuthenticatedServices"){s("Received request to stop authenticated services"),await M();return}if(e.action==="auto-swiper-message-backgroundjs-start"){s("recived: auto-swiper-message-backgroundjs-start");let i="https://tinder.com/app/recs",o="*://tinder.com/app/*";switch(e.options.site){case"tinder":i="https://tinder.com/app/recs",o="*://*.tinder.com/app/*";break;case"bumble":i="https://bumble.com/app",o="*://*.bumble.com/app/*";break;case"lovoo":i="https://www.lovoo.com/match",o="*://*.lovoo.com/*";break;case"okcupid":i="https://www.okcupid.com/discover",o="*://*.okcupid.com/*";break;case"badoo":i="https://www.badoo.com/encounters",o="*://*.badoo.com/*";break;case"pof":i="https://www.pof.com/meetme",o="*://*.pof.com/*";break;case"zoosk":i="https://www.zoosk.com/personals/search",o="*://*.zoosk.com/personals/*";break;case"match":i="https://match.com",o="*://*.match.com/d/*";break}n.tabs.query({url:o}).then(r=>{if(r.length>0){const d=parseInt(r[0].id.toString());n.tabs.update(d,{active:!0}).then(async()=>{e.options.tabId=d,f=e,D=!0;try{await n.tabs.get(f.options.tabId),await n.tabs.sendMessage(f.options.tabId,{action:"auto-swiper-message-contentjs-ignore-unload"}),await n.tabs.reload(e.options.tabId)}catch{s(`Tab ${f.options.tabId} does not exist. Skipping sendMessage/reload.`)}})}else n.tabs.create({url:i}).then(async d=>{const w=parseInt(d.id.toString());e.options.tabId=w,f=e,D=!0})})}if(e.action==="auto-swiper-message-backgroundjs-send-notification"&&(s("recived: auto-swiper-message-backgroundjs-send-notification"),De(e.message)),e.action==="auto-swiper-message-backgroundjs-reload-tab"&&(s("recived: auto-swiper-message-backgroundjs-reload-tab"),P=!0,T.has(e.tabId)?n.tabs.get(e.tabId).then(()=>{chrome.debugger.detach({tabId:e.tabId},()=>{T.delete(e.tabId)})}).catch(()=>{s(`Tab ${e.tabId} does not exist. Skipping debugger.detach.`)}):s(`Debugger is not attached to tab ${e.tabId}, skipping detach.`),V=!0,A=e,n.tabs.get(e.options.tabId).then(()=>{n.tabs.reload(e.options.tabId)}).catch(()=>{s(`Tab ${e.options.tabId} does not exist. Skipping reload.`)})),e.action==="auto-swiper-message-backgroundjs-loaded"&&D&&(s("recived: auto-swiper-message-backgroundjs-loaded start after reload"),D=!1,n.tabs.get(f.options.tabId).then(()=>{n.tabs.sendMessage(f.options.tabId,{action:"auto-swiper-message-contentjs-start",options:f.options})}).catch(()=>{s(`Tab ${f.options.tabId} does not exist. Skipping sendMessage (start after reload).`)})),e.action==="auto-swiper-message-backgroundjs-loaded"&&V&&(s("recived: auto-swiper-message-backgroundjs-loaded"),s(A),V=!1,debuggerAttachedTabId=0,A.options.enableDelayAfterPageReload?(s("send alarm set: "+A.options.delayAfterPageReload+"mins"),n.alarms.create("auto-swiper-alarm-start",{delayInMinutes:A.options.delayAfterPageReload})):(s("auto-swiper will start after 5 seconds"),setTimeout(function(){s("sent: auto-swiper-message-contentjs-start-after-tab-reload"),s(A.cardTries),n.tabs.get(A.options.tabId).then(()=>{n.tabs.sendMessage(A.options.tabId,{action:"auto-swiper-message-contentjs-start-after-tab-reload",swipeCounts:A.swipeCounts,options:A.options,cardTries:A.cardTries})}).catch(()=>{s(`Tab ${A.options.tabId} does not exist. Skipping sendMessage (start after tab reload).`)})},5e3))),e.action==="auto-swiper-message-backgroundjs-spoof-location"&&(s("recived: auto-swiper-message-backgroundjs-spoof-location"),G(),Re()),e.action==="auto-swiper-message-backgroundjs-simulate-mouse-click"&&(s("recived: auto-swiper-message-backgroundjs-simulate-mouse-click"),je(e.tabId,e.x,e.y)),e.action==="auto-swiper-message-backgroundjs-simulate-key-event"&&(s("recived: auto-swiper-message-backgroundjs-simulate-key-event"),_e(e.tabId,e.keyData)),e.action==="auto-swiper-message-backgroundjs-start-loop")try{H(),s("recived: auto-swiper-message-backgroundjs-start-loop"),s("siteSwipeSpeedModifier from request:",e.siteSwipeSpeedModifier),P=!1,p=e.options,typeof e.siteSwipeSpeedModifier=="number"&&!isNaN(e.siteSwipeSpeedModifier)?x=e.siteSwipeSpeedModifier:(x=1,s("Using default siteSwipeSpeedModifier: 1")),s("siteSwipeSpeedModifier set to:",x),(!p.minMaxSwipeTime||!Array.isArray(p.minMaxSwipeTime)||p.minMaxSwipeTime.length<2)&&(s("Warning: Invalid minMaxSwipeTime, setting default"),p.minMaxSwipeTime=[1e3,3e3]),s("Calling loop() function..."),ue()}catch(i){s("Error in start-loop handler:",i)}e.action==="auto-swiper-message-backgroundjs-stop-loop"&&(s("recived: auto-swiper-message-backgroundjs-stop-loop"),P=!0,p=null,x=1,T.has(e.tabId)?n.tabs.get(e.tabId).then(()=>{chrome.debugger.detach({tabId:e.tabId},()=>{T.delete(e.tabId)})}).catch(()=>{s(`Tab ${e.tabId} does not exist. Skipping debugger.detach (stop-loop).`)}):s(`Debugger is not attached to tab ${e.tabId}, skipping detach (stop-loop).`)),e.action==="auto-swiper-message-backgroundjs-stopped"&&(s("recived: auto-swiper-message-backgroundjs-stopped"),P=!0,x=1,T.has(e.tabId)?n.tabs.get(e.tabId).then(()=>{chrome.debugger.detach({tabId:e.tabId},()=>{T.delete(e.tabId)})}).catch(()=>{s(`Tab ${e.tabId} does not exist. Skipping debugger.detach (stopped).`)}):s(`Debugger is not attached to tab ${e.tabId}, skipping detach (stopped).`)),e.action==="auto-swiper-message-backgroundjs-create-restart-alarm"&&(s("recived: auto-swiper-message-backgroundjs-create-restart-alarm"),P=!0,p=null,x=1,B=e,s("created: auto-swiper-alarm-restart"),s("auto-swiper break duration is: "+e.breakDuration+"mins"),n.alarms.create("auto-swiper-alarm-restart",{delayInMinutes:e.breakDuration})),e.action==="auto-swiper-message-backgroundjs-toggle-image-blocking"&&(console.log("recived: auto-swiper-message-backgroundjs-toggle-image-blocking"),Fe()),t()}),n.alarms.onAlarm.addListener(function(e){e.name==="auto-swiper-alarm-start"&&(s("recived: auto-swiper-alarm-start"),s("sent: auto-swiper-message-contentjs-start-after-tab-reload"),s(A.cardTries),n.tabs.sendMessage(A.options.tabId,{action:"auto-swiper-message-contentjs-start-after-tab-reload",swipeCounts:A.swipeCounts,options:A.options,cardTries:A.cardTries}),chrome.alarms.clear("auto-swiper-alarm-start")),e.name==="auto-swiper-alarm-loop"&&(s("recived: auto-swiper-alarm-loop"),ue(),chrome.alarms.clear("auto-swiper-alarm-loop")),e.name==="auto-swiper-alarm-restart"&&(s("recived: auto-swiper-alarm-restart"),s("sent: auto-swiper-message-contentjs-restart"),n.tabs.get(B.options.tabId).then(()=>{n.tabs.sendMessage(B.options.tabId,{action:"auto-swiper-message-contentjs-restart"})}).catch(()=>{s(`Tab ${B.options.tabId} does not exist. Skipping sendMessage (restart).`)}),chrome.alarms.clear("auto-swiper-alarm-restart"))});const U="heartbeat",me=5;let Z=0;const $="scheduled-session-polling",K=5;let J=!1;async function pe(){s("Initializing heartbeat system...");const e=await n.storage.local.get({loginToken:"",uuid:"",instanceRegistered:!1});if(!e.loginToken||!e.uuid||!e.instanceRegistered){s("Skipping heartbeat initialization - user not logged in or registered");return}await n.alarms.clear(U),await n.alarms.create(U,{delayInMinutes:me,periodInMinutes:me}),await n.storage.local.set({heartbeatStatus:"connected",lastActivity:new Date().toISOString()}),await Q(),s("Heartbeat system initialized")}function he(){const e=navigator.userAgent;let a="unknown",t="unknown",i=navigator.platform||"unknown";if(e.includes("Chrome")){a="chrome";const o=e.match(/Chrome\/([0-9.]+)/);t=o?o[1]:"unknown"}else if(e.includes("Firefox")){a="firefox";const o=e.match(/Firefox\/([0-9.]+)/);t=o?o[1]:"unknown"}else if(e.includes("Safari")){a="safari";const o=e.match(/Version\/([0-9.]+)/);t=o?o[1]:"unknown"}return{browser:a,version:t,platform:i}}async function Ae(){try{const e=await n.storage.local.get({isSwiping:!1,currentScheduledSession:null,scheduledSessionStatus:"idle",lastActivity:null});return{status:e.isSwiping?"active":e.scheduledSessionStatus||"idle",current_session_id:e.currentScheduledSession||null,last_activity:e.lastActivity||new Date().toISOString()}}catch(e){return s("Error getting extension status:",e),{status:"idle",current_session_id:null,last_activity:new Date().toISOString()}}}async function Q(){const e=Date.now();if(!(e-Z<6e4))try{if(!await C()){s("Skipping heartbeat - authentication validation failed"),await M();return}const t=await n.storage.local.get({loginToken:"",uuid:"",instanceRegistered:!1}),i=he(),o=await Ae(),r={instance_id:t.uuid,status:o.status,current_session_id:o.current_session_id,extension_version:n.runtime.getManifest().version,browser_info:i,timestamp:new Date().toISOString()},d={loginToken:t.loginToken,uuid:t.uuid};await ge(r,d,{request:async E=>{const F={method:E.method,headers:{"Content-Type":"application/json",Accept:"application/json",...E.headers}};E.data&&(E.method==="POST"||E.method==="PUT")&&(F.body=JSON.stringify(E.data));const v=await fetch(E.url,F);if(!v.ok)throw new Error(`HTTP ${v.status}: ${v.statusText}`);return{data:await v.json(),status:v.status}}},null),Z=e,await n.storage.local.set({lastHeartbeat:new Date().toISOString(),heartbeatStatus:"connected"}),s("Heartbeat sent successfully")}catch(a){s("Heartbeat failed:",a),a.message&&(a.message.includes("401")||a.message.includes("403")||a.message.includes("Failed to fetch"))&&(s("Authentication error detected, clearing data and stopping services"),await _(),await M()),await n.storage.local.set({heartbeatStatus:"error"})}}const be=async()=>{try{if(!await C()){s("[Scheduled Sessions] Skipping polling initialization - authentication validation failed");return}const a=await n.storage.local.get({isUltimate:!1,scheduledSessionsEnabled:!1});if(!a.isUltimate){s("[Scheduled Sessions] Skipping polling initialization - Ultimate subscription required");return}if(!a.scheduledSessionsEnabled){s("[Scheduled Sessions] Skipping polling initialization - scheduled sessions feature not enabled for this user");return}await n.alarms.clear($),await n.alarms.create($,{delayInMinutes:K,periodInMinutes:K}),J=!0,s("[Scheduled Sessions] Polling service initialized - checking every",K,"minutes")}catch(e){s("[Scheduled Sessions] Error initializing polling service:",e)}},fe=async()=>{if(J)try{if(s("[Scheduled Sessions] Checking for due sessions..."),!await C()){s("[Scheduled Sessions] Authentication validation failed, stopping polling"),await M();return}if(!P&&p&&p.tabId){s("[Scheduled Sessions] Manual swiping session is already active on tab:",p.tabId,"- skipping scheduled session check");return}const a=await n.storage.local.get(["uuid","loginToken","userId","loginEmail","isFree","isBasic","isPro","isUltimate","instanceRegistered","scheduledSessionsEnabled"]);if(!a.isUltimate){s("[Scheduled Sessions] User does not have Ultimate subscription, stopping polling"),await M();return}if(!a.scheduledSessionsEnabled){s("[Scheduled Sessions] Scheduled sessions feature not enabled for this user, stopping polling"),await M();return}const t={uuid:a.uuid,loginToken:a.loginToken,userId:a.userId,loginEmail:a.loginEmail,isFree:a.isFree||!1,isBasic:a.isBasic||!1,isPro:a.isPro||!1,isUltimate:a.isUltimate||!1},i=await ce(t,null,null);if(i&&i.data&&i.data.id){const o=i.data;Oe(o)?(s("[Scheduled Sessions] Found due session:",o.name,"for site:",o.site),await we(o,t)):s("[Scheduled Sessions] Session found but outside execution window (>10 min overdue):",o.name,"scheduled for:",o.scheduled_at)}else s("[Scheduled Sessions] No due sessions found")}catch(e){s("[Scheduled Sessions] Error checking for sessions:",e),e.message&&(e.message.includes("401")||e.message.includes("403")||e.message.includes("Failed to fetch"))&&(s("[Scheduled Sessions] Authentication error detected, clearing data and stopping services"),await _(),await M())}},Oe=e=>{try{const a=new Date,t=new Date(e.scheduled_at),o=(a.getTime()-t.getTime())/(1e3*60),r=o>=0&&o<=10;return r||s("[Scheduled Sessions] Time window check failed:",{now:a.toISOString(),scheduled:t.toISOString(),minutesOverdue:Math.round(o*100)/100,maxAllowedMinutes:10}),r}catch(a){return s("[Scheduled Sessions] Error validating time window:",a),!1}},we=async(e,a)=>{let t=null;try{s("[Scheduled Sessions] Starting execution of session:",e.name);const{startSession:i}=await Promise.resolve().then(()=>Pe),o={site:e.site,scheduled_session_id:e.id},r=await i(o,a,null,null);if(!r||!r.status)throw new Error("Failed to start session execution on backend");t=r.data.session_id,s("[Scheduled Sessions] Session started with unified approach, session ID:",t);const d=Se(e,a);d.sessionStartedAt=new Date().toISOString(),d.sessionId=t,d.scheduledSessionId=e.id,await Ne({action:"auto-swiper-message-backgroundjs-start",options:d},e,t)}catch(i){s("[Scheduled Sessions] Error executing session:",i);try{t?await de(t,{reason:"Scheduled session execution failed",message:i.message,stack:i.stack,timestamp:new Date().toISOString(),session_type:"scheduled"},a,null,null):s("[Scheduled Sessions] No session ID available, cannot report failure to backend")}catch(o){s("[Scheduled Sessions] Failed to report session error:",o)}}},Se=(e,a)=>{const t=e.swipe_options||{},i=t.maxSwipes||[50,50],o=Array.isArray(i)?Math.round(Math.random()*(i[1]-i[0])+i[0]):i;return{uuid:a.uuid,isFree:a.isFree,isBasic:a.isBasic,isPro:a.isPro,isUltimate:a.isUltimate,userId:a.userId,userEmail:a.loginEmail,site:e.site,enableAgeFilter:t.enableAgeFilter!==void 0?t.enableAgeFilter:!1,minMaxAge:t.minMaxAge||[18,35],enableHeightFilter:t.enableHeightFilter!==void 0?t.enableHeightFilter:!1,minMaxHeight:t.minMaxHeight||[150,200],enableDistanceFilter:t.enableDistanceFilter!==void 0?t.enableDistanceFilter:!1,maxDistance:t.maxDistance!==void 0?t.maxDistance:50,skipEmptyDistance:t.skipEmptyDistance!==void 0?t.skipEmptyDistance:!1,extendedDistance:t.extendedDistance!==void 0?t.extendedDistance:!1,enableMinPicturesFilter:t.enableMinPicturesFilter!==void 0?t.enableMinPicturesFilter:!1,minPictures:t.minPictures!==void 0?t.minPictures:1,enableMaxSwipesFilter:t.enableMaxSwipesFilter!==void 0?t.enableMaxSwipesFilter:!0,maxSwipes:o,enableLeftSwipesPercentageFilter:t.enableLeftSwipesPercentageFilter!==void 0?t.enableLeftSwipesPercentageFilter:!1,leftSwipePercentages:t.leftSwipePercentages||[25,55],minMaxSwipeTime:t.minMaxSwipeTime||[1,3],enableBreak:t.enableBreak!==void 0?t.enableBreak:!1,breakBetweenSwipes:t.breakBetweenSwipes||[10,20],breakDuration:t.breakDuration||[30,60],enableAutomaticPageReload:t.enableAutomaticPageReload!==void 0?t.enableAutomaticPageReload:!1,reloadPageBetweenSwipes:t.reloadPageBetweenSwipes||[50,100],enableDelayAfterPageReload:t.enableDelayAfterPageReload!==void 0?t.enableDelayAfterPageReload:!1,delayBetweenAfterPageReload:t.delayBetweenAfterPageReload||[3,7],enableRandomUsageSimulation:t.enableRandomUsageSimulation!==void 0?t.enableRandomUsageSimulation:!1,randomUsageSimulation:t.randomUsageSimulation||[0,0],noEmptyDescription:t.noEmptyDescription!==void 0?t.noEmptyDescription:!1,onlyVerifyedProfiles:t.onlyVerifyedProfiles!==void 0?t.onlyVerifyedProfiles:!1,onlyRecentlyActive:t.onlyRecentlyActive!==void 0?t.onlyRecentlyActive:!1,bannedWords:t.bannedWords||[],preferredWords:t.preferredWords||[],requiredWords:t.requiredWords||[],theme:t.theme||"dark",withNotification:t.withNotification!==void 0?t.withNotification:!0,withDebuggerOutput:t.withDebuggerOutput!==void 0?t.withDebuggerOutput:!1,withImageBlocking:t.withImageBlocking!==void 0?t.withImageBlocking:!1,stopOnRightSwipe:t.stopOnRightSwipe!==void 0?t.stopOnRightSwipe:!1,enableGatheringPictureUrls:t.enableGatheringPictureUrls!==void 0?t.enableGatheringPictureUrls:!1,showTinder:t.showTinder!==void 0?t.showTinder:!0,showBumble:t.showBumble!==void 0?t.showBumble:!0,showOkCupid:t.showOkCupid!==void 0?t.showOkCupid:!0,showLovoo:t.showLovoo!==void 0?t.showLovoo:!0,showBadoo:t.showBadoo!==void 0?t.showBadoo:!0,showPoF:t.showPoF!==void 0?t.showPoF:!0,showZoosk:t.showZoosk!==void 0?t.showZoosk:!0,showMatch:t.showMatch!==void 0?t.showMatch:!0,longitude:t.longitude||null,latitude:t.latitude||null,stats:{},swipeLog:[],tabId:null,forceMatch:!1,isScheduledSession:!0,scheduledSessionId:e.id,scheduledSessionName:e.name}},Ne=async(e,a,t)=>{s("[Scheduled Sessions] Processing session start for site:",e.options.site);let i="https://tinder.com/app/recs",o="*://tinder.com/app/*";switch(e.options.site){case"tinder":i="https://tinder.com/app/recs",o="*://*.tinder.com/app/*";break;case"bumble":i="https://bumble.com/app",o="*://*.bumble.com/app/*";break;case"lovoo":i="https://www.lovoo.com/match",o="*://*.lovoo.com/*";break;case"okcupid":i="https://www.okcupid.com/discover",o="*://*.okcupid.com/*";break;case"badoo":i="https://www.badoo.com/encounters",o="*://*.badoo.com/*";break;case"pof":i="https://www.pof.com/meetme",o="*://*.pof.com/*";break;case"zoosk":i="https://www.zoosk.com/personals/search",o="*://*.zoosk.com/personals/*";break;case"match":i="https://match.com",o="*://*.match.com/d/*";break}const r=await n.tabs.query({url:o});if(r.length>0){const d=parseInt(r[0].id.toString());await n.tabs.update(d,{active:!0}),e.options.tabId=d,f=e,D=!0;try{await n.tabs.get(f.options.tabId),await n.tabs.sendMessage(f.options.tabId,{action:"auto-swiper-message-contentjs-ignore-unload"}),await n.tabs.reload(e.options.tabId)}catch{s(`[Scheduled Sessions] Tab ${f.options.tabId} does not exist. Skipping sendMessage/reload.`)}}else{const d=await n.tabs.create({url:i}),w=parseInt(d.id.toString());e.options.tabId=w,f=e,D=!0}s("[Scheduled Sessions] Session execution initiated for tab:",e.options.tabId)};n.alarms.onAlarm.addListener(async e=>{e.name===U?await Q():e.name===$&&await fe()});async function C(){const e=await n.storage.local.get({loginToken:"",uuid:"",instanceRegistered:!1});return!e.loginToken||!e.uuid||!e.instanceRegistered?!1:e.loginToken.length<20?(s("Stored token is too short, clearing authentication data"),await _(),!1):!0}async function _(){await n.storage.local.remove(["loginToken","uuid","instanceRegistered","userId","heartbeatStatus","lastHeartbeat","lastActivity","scheduledSessionsEnabled","isFree","isBasic","isPro","isUltimate"]),s("Authentication data cleared from storage")}n.runtime.onStartup.addListener(async()=>{await C()?(s("Extension startup - user is authenticated, starting services"),await X()):s("Extension startup - user not authenticated, services not started")}),n.runtime.onInstalled.addListener(async()=>{s("Extension installed/updated - clearing any stale authentication data"),await _(),s("Extension installed - services not started (user needs to login)")});async function X(){if(s("Starting authenticated services..."),!await C()){s("Authentication validation failed, not starting services");return}await pe();const a=await n.storage.local.get({isUltimate:!1,scheduledSessionsEnabled:!1});a.isUltimate&&a.scheduledSessionsEnabled?(s("User has Ultimate subscription and scheduled sessions enabled, starting polling"),await be()):s("Scheduled session polling not started - Ultimate subscription and scheduled sessions feature required")}async function M(){s("Stopping authenticated services..."),await n.alarms.clear(U),await n.alarms.clear($),J=!1,Z=0,await n.storage.local.set({heartbeatStatus:"disconnected",lastActivity:new Date().toISOString()}),s("Authenticated services stopped")}typeof module<"u"&&module.exports&&(module.exports={initializeHeartbeat:pe,performHeartbeatCheck:Q,getBrowserInfo:he,getExtensionStatus:Ae,initializeScheduledSessionPolling:be,checkForScheduledSessions:fe,executeScheduledSession:we,convertScheduledSessionToSwipeOptions:Se,startAuthenticatedServices:X,stopAuthenticatedServices:M,validateStoredAuthentication:C,clearAuthenticationData:_})})();
